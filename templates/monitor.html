<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor CCTV</title>

  <style>
    html, body { margin: 0; padding: 0; overflow-x: hidden; }
    .wrapper {
      position: relative;
      width: 100%;
      background: url("{{ url_for('static', filename='img/backgroundcctv.png') }}") no-repeat top center;
      background-size: 100% auto;
    }
    .btn { position: absolute; cursor: pointer; transform: translate(-50%, -50%); }
    .btn-cctv { top: 7%; left: 44%; width: 5.5%; }
    .btn-deteksi { top: 6.9%; left: 54%; width: 7%; }
    .btn-dashboard { top: 7%; left: 66.5%; width: 10%; }
    .btn-tentang { top: 7.2%; left: 81.5%; width: 12.5%; }
    .btn-profile { top: 7.1%; left: 95%; width: 5.5%; }

    /* logo */
    .logo-gcs {
    position: absolute;
    top: 0.05%;
    left: 1.45%;
    width: 10%;  
    cursor: pointer;
  }

    .camera-select {
      position: absolute;
      top: 23.5%; left: 86.3%;
      width: 18%;
      transform: translate(-50%, -50%);
      background-color: #5b863f;
      color: #FFCE5E;
      border: none; border-radius: 5px;
      padding: 0.4em;
      font-size: 1vw;
      cursor: pointer;
    }

    .camera-select option {
      background-color: #5b863f;
      color: #fff;
    }

    #monitor-video {
      position: absolute;
      top: 16%;
      left: 3.5%;
      width: 71.75%;
      height: 79.5%;
      border-radius: 25px;
      background: #000;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="wrapper" id="wrapper">
    <!-- LOGO -->
    <a href="{{ url_for('home') }}">
      <img src="{{ url_for('static', filename='img/logo_gcs.png') }}" class="logo-gcs" alt="Logo GCS">
    </a>

    <!-- tombol navigasi -->
    <a href="{{ url_for('monitor') }}"><img src="{{ url_for('static', filename='img/CCTV.png') }}" class="btn btn-cctv"></a>
    <a href="{{ url_for('detect') }}"><img src="{{ url_for('static', filename='img/deteksi.png') }}" class="btn btn-deteksi"></a>
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='img/dashboard.png') }}" class="btn btn-dashboard"></a>
    <a href="{{ url_for('about') }}"><img src="{{ url_for('static', filename='img/tentang-kami.png') }}" class="btn btn-tentang"></a>
    <a href="{{ url_for('profile') }}"><img src="{{ url_for('static', filename='img/profile.png') }}" class="btn btn-profile"></a>

    <!-- dropdown camera -->
    <select id="cameraSelect" class="camera-select">
      <option>Loading cameras...</option>
    </select>

    <!-- FRAME + VIDEO -->
    <div id="monitor-frame">
      <video id="monitor-video" autoplay playsinline></video>
    </div>
  </div>

  <!-- helper image -->
  <img id="bg-helper" src="{{ url_for('static', filename='img/backgroundcctv.png') }}" style="display:none;">

  <script>
    const helper = document.getElementById("bg-helper");
    const wrapper = document.getElementById("wrapper");
    function setWrapperHeight() {
      const aspect = helper.naturalHeight / helper.naturalWidth;
      wrapper.style.height = wrapper.offsetWidth * aspect + "px";
      document.body.style.height = wrapper.style.height;
    }
    helper.onload = setWrapperHeight;
    window.addEventListener("resize", setWrapperHeight);

    const monitorVideo = document.getElementById("monitor-video");
    const cameraSelect = document.getElementById("cameraSelect");
    let currentStream = null;

    async function startCamera(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      try {
        const constraints = deviceId 
          ? { video: { deviceId: { exact: deviceId } } } 
          : { video: true };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        monitorVideo.srcObject = stream;
      } catch (err) {
        alert("Gagal akses kamera: " + err.message);
        console.error("Gagal akses kamera:", err);
      }
    }

    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === "videoinput");

        cameraSelect.innerHTML = "";
        videoDevices.forEach((device, index) => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Camera ${index + 1}`;
          cameraSelect.appendChild(option);
        });

        if (videoDevices.length > 0) {
          startCamera(videoDevices[0].deviceId);
        } else {
          cameraSelect.innerHTML = "<option>No cameras found</option>";
        }
      } catch (err) {
        console.error("Gagal memuat kamera:", err);
      }
    }

    cameraSelect.addEventListener("change", () => {
      startCamera(cameraSelect.value);
    });

    window.addEventListener("DOMContentLoaded", loadCameras);
  </script>
</body>
</html>
