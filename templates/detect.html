{% extends "base.html" %}
{% block title %}Deteksi CCTV{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deteksi CCTV</title>

  <style>
    html, body { margin: 0; padding: 0; overflow-x: hidden; }
    .wrapper {
      position: relative;
      width: 100%;
      background: url("{{ url_for('static', filename='img/backgroundcctv.png') }}") no-repeat top center;
      background-size: 100% auto;
    }

    /* tombol navigasi */
    .btn { position: absolute; cursor: pointer; transform: translate(-50%, -50%); }
    .btn-cctv { top: 7%; left: 44%; width: 5.5%; }
    .btn-deteksi { top: 6.9%; left: 54%; width: 7%; }
    .btn-dashboard { top: 7%; left: 66.5%; width: 10%; }
    .btn-tentang { top: 7.2%; left: 81.5%; width: 12.5%; }
    .btn-profile { top: 7.1%; left: 95%; width: 5.5%; }

    /* logo */
    .logo-gcs {
    position: absolute;
    top: 0.05%;
    left: 1.45%;
    width: 10%; 
    cursor: pointer;
  }

    /* hasil YOLO ditampilkan di posisi monitor */
    #output {
      position: absolute;
      top: 16%;
      left: 3.5%;
      width: 71.75%;
      height: 79.5%;
      border-radius: 25px;
      background: #000;
      object-fit: contain;
      z-index: 10;
    }

    /* video & canvas hidden */
    #video, #canvas { display: none; }
  </style>
</head>
<body>
  <div class="wrapper" id="wrapper">
    <!-- LOGO -->
    <a href="{{ url_for('home') }}">
      <img src="{{ url_for('static', filename='img/logo_gcs.png') }}" class="logo-gcs" alt="Logo GCS">
    </a>

    <!-- tombol navigasi -->
    <a href="{{ url_for('monitor') }}"><img src="{{ url_for('static', filename='img/CCTV.png') }}" class="btn btn-cctv"></a>
    <a href="{{ url_for('detect') }}"><img src="{{ url_for('static', filename='img/deteksi.png') }}" class="btn btn-deteksi"></a>
    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='img/dashboard.png') }}" class="btn btn-dashboard"></a>
    <a href="{{ url_for('about') }}"><img src="{{ url_for('static', filename='img/tentang-kami.png') }}" class="btn btn-tentang"></a>
    <a href="{{ url_for('profile') }}"><img src="{{ url_for('static', filename='img/profile.png') }}" class="btn btn-profile"></a>

    <!-- hasil YOLO -->
    <img id="output" alt="YOLO Output">

    <!-- hidden elemen -->
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>

  <!-- helper image -->
  <img id="bg-helper" src="{{ url_for('static', filename='img/backgroundcctv.png') }}" style="display:none;">

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const output = document.getElementById("output");

    const helper = document.getElementById("bg-helper");
    const wrapper = document.getElementById("wrapper");
    function setWrapperHeight() {
      const aspect = helper.naturalHeight / helper.naturalWidth;
      wrapper.style.height = wrapper.offsetWidth * aspect + "px";
      document.body.style.height = wrapper.style.height;
    }
    helper.onload = setWrapperHeight;
    window.addEventListener("resize", setWrapperHeight);

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        console.error("Gagal akses kamera:", err);
      }
    }

    async function sendFrame() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(r => canvas.toBlob(r, "image/jpeg"));

      if (!blob) return;
      const formData = new FormData();
      formData.append("frame", blob, "frame.jpg");

      try {
        const response = await fetch("/detect_api", { method: "POST", body: formData });
        if (response.ok) {
          const blobResp = await response.blob();
          if (blobResp.size > 0) {
            const objectUrl = URL.createObjectURL(blobResp);
            output.src = objectUrl;
            output.onload = () => URL.revokeObjectURL(objectUrl);
          }
        } else {
          console.error("Server error:", response.status);
        }
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }

    video.addEventListener("loadeddata", () => {
      setInterval(sendFrame, 700); // kirim frame tiap 0.7 detik
    });

    startCamera();
  </script>
</body>
</html>
{% endblock %}
